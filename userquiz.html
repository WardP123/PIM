<!doctype html>
<html>

<head>
<meta charset="utf-8">
<title>Quiz invullen</title>
<link href="userquizcss.css" rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
	function getQueryVariable(variable){
		var query = window.location.search.substring(1);
		var vars = query.split("&");
		for (var i=0;i<vars.length;i++) {
		   var pair = vars[i].split("=");
		   if(pair[0] == variable){return pair[1];}
		}
		return("NO VALID LINK");
	}
	
	var quizappointmentid_local = getQueryVariable("quizid");
	
	function LoadQuestions(){
		$.ajax({
			url: "http://84.28.82.98:8081/retrieve-questions",
			type: 'POST',
			data: JSON.stringify({ quizid: quizappointmentid_local }),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			async: true,
			success: function(data) {
				process_questions(data);
			},
			error: function(data) {
				alert("Vragen laden mislukt.");
			}
		});
	}
	
	function LoadQuizTitle(){
		$.ajax({
			url: "http://84.28.82.98:8081/quiz-title",
			type: 'POST',
			data: JSON.stringify({ quizid: quizappointmentid_local }),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			async: true,
			success: function(data) {
				document.getElementById("quiztitle").innerHTML = data[0].title;
			},
			error: function(data) {
				alert("Vragen laden mislukt.");
			}
		});
	}
	
	function process_questions(data){
		var question_counter = 0;
		for (question in data){
			question_counter += 1;
			
			var maindiv = document.createElement('div');
			maindiv.setAttribute("class", "question");
			maindiv.setAttribute("id", data[question].id);
			maindiv.setAttribute("onclick", "expand_question(this.id)");
			maindiv.setAttribute("style", "cursor: pointer;");
			
			var titlediv = document.createElement('div');
			titlediv.setAttribute("class", "title");
			titlediv.innerHTML = "Vraag " + question_counter + ": ";
			
			var namespan = document.createElement('span');
			namespan.innerHTML = data[question].question_title;
			
			var formdiv = document.createElement('form');
			formdiv.setAttribute("id", 'formdiv' + data[question].id);
			formdiv.setAttribute("class", "invisible");
		
			var descriptiondiv = document.createElement('div');
			descriptiondiv.innerHTML = data[question].question;
			descriptiondiv.setAttribute("class", "description");
			formdiv.appendChild(descriptiondiv);
		
			var breakdiv = document.createElement('br');
			formdiv.appendChild(breakdiv);
			
			if (data[question].image){
				alert(data[question].image);
			}
			
			if (data[question].answer_type == "text"){
				var answerdiv = document.createElement('textarea');
				answerdiv.setAttribute("rows", "4");
				answerdiv.setAttribute("cols", "50");
				answerdiv.setAttribute("id", "imageinput" +data[question].id);
				answerdiv.setAttribute("class", "input");
				formdiv.appendChild(answerdiv);
			}
			else{
				var answerdiv = document.createElement('input');
				answerdiv.setAttribute("type", "file");
				answerdiv.setAttribute("accept", "image/*");
				answerdiv.setAttribute("id", "inputfield" +data[question].id);
				formdiv.appendChild(answerdiv);
			}
		
			var breakdiv2 = document.createElement('br');
			formdiv.appendChild(breakdiv2);
		
			var submitbutton = document.createElement('input');
			submitbutton.setAttribute("type", "button");
			submitbutton.setAttribute("value", "Antwoord indienen");
			submitbutton.setAttribute("id", data[question].id);
			submitbutton.setAttribute("onclick", "process_answer(this.id)");
			formdiv.appendChild(submitbutton);

			var closediv = document.createElement('span');
			closediv.setAttribute('class', 'invisible');
			closediv.setAttribute('id', 'close' + data[question].id);
			closediv.setAttribute('onclick', 'close_question(this.parentElement.id)');
			closediv.setAttribute('onmouseover', "");
			closediv.innerHTML = "&times;";
			
			maindiv.appendChild(closediv);
			titlediv.appendChild(namespan);
			maindiv.appendChild(titlediv);
			maindiv.appendChild(formdiv);
			document.getElementById("questioncontainer").appendChild(maindiv);
		}
	}
	
	function expand_question(id){
		// document.getElementById(id).setAttribute("class", "openedquestion");
		document.getElementById(id).className = "openedquestion";
		document.getElementById(id).setAttribute("onclick", "");
		
		document.getElementById("formdiv" + id).setAttribute("class", "visible");
		document.getElementById("close" + id).setAttribute("class", "show");
	}
	
	function close_question(id){
		document.getElementById(id).setAttribute("onclick", "expand_question(this.id)");
		document.getElementById(id).className = "question";
		document.getElementById("formdiv" + id).style.display = "none";
		document.getElementById("close" + id).style.display = "none";
	}
	
	function process_answer(id){
	var question_id_local = id;
	var quiz_id_local = quizappointmentid_local;
	var username_local = "Test User";
	var gameid_local = 12;
	var answerfield = document.getElementById("inputfield" +id);
	var imagefield = document.getElementById("imageinput" +id);
	if (answerfield != null){
		var answer_local = answerfield.value;
	}
	else {
		var answer_local = null;
	}
	if (imagefield != null){
		var image_local = imagefield.value;
	}
	else{
		var image_local = null;
	}
	
	$.ajax({
			url: "http://84.28.82.98:8081/answer-question",
			type: 'POST',
			data: JSON.stringify({ question_id: question_id_local, quiz_id: quiz_id_local, username: username_local, gameid: gameid_local, answer: answer_local, answerimage: image_local }),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			async: true,
			success: function(data) {
				alert("Antwoord ingediend.");
				close_question(question_id_local);
			},
			error: function(data) {
				alert("Vragen laden mislukt.");
			}
		});
	}
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body onload="LoadQuestions(); LoadQuizTitle();">
	<div id="header">
		<img src="klassetourzwart.png"></div>
	</div>
	<h1 class="QuizTitle">Welkom bij <span id="quiztitle"></span></h1>
	<br>
	<div id="questioncontainer">
	</div>
</body>

</html>